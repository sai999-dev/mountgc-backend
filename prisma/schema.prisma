// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id              Int       @id @default(autoincrement())
  username             String    @unique
  email                String    @unique
  password             String
  user_role            String    @default("student")
  email_verify         Boolean   @default(false)
  email_verified_at    DateTime?
  verification_token   String?   @unique
  token_expires_at     DateTime?
  password_reset_token String?   @unique
  password_reset_expires DateTime?
  is_active            Boolean   @default(true)
  created_at           DateTime  @default(now())
  refresh_token        String?   @db.Text
  last_login_at        DateTime?

  device_sessions      DeviceSession[]
  research_purchases   ResearchPaperPurchase[] @relation("UserResearchPurchases")
  visa_purchases       VisaApplicationPurchase[] @relation("UserVisaPurchases")
  counselling_purchases CounsellingPurchase[] @relation("UserCounsellingPurchases")
  transactions         Transaction[]
  user_agreements      UserAgreement[]

  @@map("users")
}

model DeviceSession {
  session_id           Int       @id @default(autoincrement())
  user_id              Int
  device_id            String    // Unique identifier for device
  device_name          String?   // Browser + OS info
  device_type          String?   // mobile, desktop, tablet
  ip_address           String?
  user_agent           String?   @db.Text
  access_token         String    @db.Text
  refresh_token        String    @db.Text
  is_active            Boolean   @default(true)
  login_at             DateTime  @default(now())
  last_activity_at     DateTime  @default(now())
  logout_at            DateTime?
  
  user                 User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([device_id])
  @@index([is_active])
  @@map("device_sessions")
}


model Booking {
  booking_id      Int       @id @default(autoincrement())
  name            String    // Person's name
  email           String    // Person's email
  phone           String?   // Optional phone number
  category        String    // General, Visa Assistance, etc.
  session_type    String    // General Counseling, Expert Counseling
  timezone        String
  booking_date    DateTime  // The date of the session
  booking_time    String    // Time slot like "10:00 AM"
  message         String?   @db.Text
  status          String    @default("pending") // pending, confirmed, completed, cancelled
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@map("bookings")
}

model timeslot {
timeslot_id Int @id @default(autoincrement())
time String
timezone String @default("IST")
is_active Boolean @default(true)
created_at DateTime @default(now())
updated_at DateTime @updatedAt

@@map("timeslots")
}

model ResearchPaperConfig {
  config_id        Int       @id @default(autoincrement())
  currency         String    // INR, USD, EUR
  co_authors       Int       // Number of co-authors (0-3)
  actual_price     Float     // Original price
  discounted_price Float     // Discounted price
  discount_percent Float     @default(20.0) // Discount percentage
  duration_weeks   String    @default("3-4 weeks") // Service duration
  is_active        Boolean   @default(true)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  
  @@unique([currency, co_authors])
  @@map("research_paper_configs")
}

model ResearchPaperPurchase {
  purchase_id      Int       @id @default(autoincrement())
  user_id          Int
  name             String
  email            String
  phone            String    // Required - contact information
  currency         String    // INR, USD, EUR
  co_authors       Int       // Number of co-authors selected
  actual_amount    Float     // Original amount
  discount_amount  Float     // Discount amount
  final_amount     Float     // Final amount to pay
  duration         String    // Service duration
  payment_status   String    @default("pending") // pending, completed, failed, refunded
  payment_id       String?   // Payment gateway transaction ID (deprecated - use transaction)
  payment_method   String?   // Card, UPI, Net Banking, etc. (deprecated - use transaction)
  research_group   Boolean   @default(false) // Whether user wants to join/create research group
  notes            String?   @db.Text // Student notes
  admin_notes      String?   @db.Text // Admin internal notes
  case_status      String    @default("open") // open, closed
  status           String    @default("initiated") // initiated, in_progress, completed, cancelled
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  user             User      @relation("UserResearchPurchases", fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([payment_status])
  @@index([status])
  @@index([case_status])
  @@map("research_paper_purchases")
}

model Transaction {
  transaction_id           Int       @id @default(autoincrement())
  user_id                  Int

  // Service details
  service_type             String    // 'research_paper', 'visa_application', 'counseling', etc.
  service_id               Int?      // ID of the specific service purchase (nullable for flexibility)

  // Amount details
  amount                   Float     // Final amount paid
  currency                 String    // INR, USD, EUR, etc.

  // Payment gateway details
  payment_gateway          String    @default("stripe") // stripe, razorpay, paypal, etc.
  payment_status           String    @default("pending") // pending, processing, completed, failed, refunded, cancelled
  payment_method           String?   // card, bank_transfer, upi, etc.

  // Stripe specific fields
  stripe_session_id        String?   @unique // Stripe Checkout Session ID
  stripe_payment_intent_id String?   @unique // Stripe Payment Intent ID
  stripe_customer_id       String?   // Stripe Customer ID for future use
  stripe_charge_id         String?   // Stripe Charge ID

  // Transaction metadata
  description              String?   @db.Text // Human readable description
  metadata                 Json?     // Flexible JSON field for additional data

  // Payment details
  paid_at                  DateTime? // When payment was completed
  refunded_at              DateTime? // When refund was processed
  cancelled_at             DateTime? // When transaction was cancelled

  // Error tracking
  error_message            String?   @db.Text // Error message if payment failed
  error_code               String?   // Error code from payment gateway

  // Timestamps
  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt

  // Relations
  user                     User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([service_type])
  @@index([service_id])
  @@index([payment_status])
  @@index([stripe_session_id])
  @@index([stripe_payment_intent_id])
  @@map("transactions")
}

model VisaApplicationConfig {
  config_id        Int       @id @default(autoincrement())
  currency         String    // INR, USD, EUR
  dependents       Int       // Number of dependents (0-2)
  mocks            Int       // Number of mock interviews (1-2)
  actual_price     Float     // Original price
  discounted_price Float     // Discounted price
  discount_percent Float     @default(20.0) // Discount percentage
  duration_months  String    @default("1-2 months") // Service duration
  is_active        Boolean   @default(true)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  @@unique([currency, dependents, mocks])
  @@map("visa_application_configs")
}

model VisaApplicationPurchase {
  purchase_id      Int       @id @default(autoincrement())
  user_id          Int
  name             String
  email            String
  phone            String    // Required - contact information
  country          String    // USA, Canada, UK
  currency         String    // INR, USD, EUR
  dependents       Int       // Number of dependents selected
  mocks            Int       // Number of mock interviews
  actual_amount    Float     // Original amount
  discount_amount  Float     // Discount amount
  final_amount     Float     // Final amount to pay (when Stripe is integrated)
  amount_paid      Float     @default(0) // Amount paid (0 until Stripe integration)
  duration         String    // Service duration
  payment_status   String    @default("pending") // pending, completed, failed, refunded (for future Stripe integration)
  visa_guarantee   Boolean   @default(true) // Visa guarantee included
  notes            String?   @db.Text // Student notes
  admin_notes      String?   @db.Text // Admin internal notes
  case_status      String    @default("open") // open, closed
  status           String    @default("initiated") // initiated, in_progress, completed, cancelled
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  order_id         String    @unique @default(uuid()) // Order reference for student/admin

  user             User      @relation("UserVisaPurchases", fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([payment_status])
  @@index([status])
  @@index([case_status])
  @@index([country])
  @@map("visa_application_purchases")
}

model TermsAndConditions {
  terms_id                    Int       @id @default(autoincrement())
  service_type                String    // 'research_paper', 'visa_application', 'counselling_session'
  counselling_service_type_id Int?      // Optional: specific counselling service type
  title                       String    // e.g., "Research Paper Service Agreement"
  content                     String    @db.Text // The actual terms & conditions text
  version                     Int       @default(1) // Version number
  is_active                   Boolean   @default(true) // Only one active version per service_type
  created_by                  String?   // Admin who created it
  created_at                  DateTime  @default(now())
  updated_at                  DateTime  @updatedAt

  user_agreements             UserAgreement[]
  counselling_service_type    CounsellingServiceType? @relation(fields: [counselling_service_type_id], references: [service_type_id], onDelete: SetNull)

  @@index([service_type])
  @@index([counselling_service_type_id])
  @@index([is_active])
  @@map("terms_and_conditions")
}

model UserAgreement {
  agreement_id                Int       @id @default(autoincrement())
  user_id                     Int
  terms_id                    Int       // Which terms version they agreed to
  service_type                String    // 'research_paper', 'visa_application', 'counselling_session'
  counselling_service_type_id Int?      // Specific counselling service type (if applicable)
  signed_name                 String    // User's typed signature
  terms_title                 String?   // Snapshot of terms title at time of signing
  terms_content               String?   @db.Text // Snapshot of terms content at time of signing
  terms_version               Int?      // Snapshot of terms version at time of signing
  ip_address                  String?   // User's IP when signing
  user_agent                  String?   @db.Text // Browser/device info
  agreed_at                   DateTime  @default(now())

  user                        User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  terms                       TermsAndConditions @relation(fields: [terms_id], references: [terms_id])
  counselling_service_type    CounsellingServiceType? @relation(fields: [counselling_service_type_id], references: [service_type_id], onDelete: SetNull)

  @@unique([user_id, service_type, counselling_service_type_id]) // User can only have one agreement per service type + counselling type
  @@index([user_id])
  @@index([service_type])
  @@index([terms_id])
  @@index([counselling_service_type_id])
  @@map("user_agreements")
}

model AdminOtp {
  id               Int       @id @default(autoincrement())
  email            String
  otp_code         String    @db.VarChar(6)
  created_at       DateTime  @default(now())
  expires_at       DateTime
  is_used          Boolean   @default(false)
  attempts         Int       @default(0)
  ip_address       String?   @db.VarChar(45)
  user_agent       String?   @db.Text

  @@index([email])
  @@index([otp_code])
  @@index([expires_at])
  @@map("admin_otp")
}

// Counselling Session Service Types (Admin manageable)
model CounsellingServiceType {
  service_type_id  Int       @id @default(autoincrement())
  name             String    // e.g., "Initial Counseling Session", "Complete Application Help"
  description      String?   @db.Text
  duration         String    @default("1 hour") // e.g., "1 hour", "2 hours"
  is_active        Boolean   @default(true)
  display_order    Int       @default(0) // For ordering in dropdown
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  pricing_configs  CounsellingPricingConfig[]
  purchases        CounsellingPurchase[]
  terms            TermsAndConditions[]
  user_agreements  UserAgreement[]

  @@map("counselling_service_types")
}

// Counselling Session Counselors (Admin manageable)
model Counselor {
  counselor_id     Int       @id @default(autoincrement())
  name             String
  role             String?   // e.g., "Senior Counselor", "Visa Specialist"
  email            String?
  is_active        Boolean   @default(true)
  display_order    Int       @default(0)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  pricing_configs  CounsellingPricingConfig[]
  purchases        CounsellingPurchase[]

  @@map("counselors")
}

// Counselling Session Pricing Configuration (Admin manageable)
model CounsellingPricingConfig {
  config_id        Int       @id @default(autoincrement())
  service_type_id  Int
  counselor_id     Int?      // Optional: different pricing per counselor
  currency         String    // INR, USD, EUR
  actual_price     Float     // Original price
  discounted_price Float     // Discounted price
  discount_percent Float     @default(20.0)
  is_active        Boolean   @default(true)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  service_type     CounsellingServiceType @relation(fields: [service_type_id], references: [service_type_id], onDelete: Cascade)
  counselor        Counselor? @relation(fields: [counselor_id], references: [counselor_id], onDelete: SetNull)

  @@unique([service_type_id, counselor_id, currency])
  @@index([service_type_id])
  @@index([counselor_id])
  @@index([currency])
  @@map("counselling_pricing_configs")
}

// Counselling Session Purchases
model CounsellingPurchase {
  purchase_id      Int       @id @default(autoincrement())
  user_id          Int
  service_type_id  Int
  counselor_id     Int?

  // Customer info
  name             String
  email            String
  phone            String

  // Pricing info
  currency         String
  actual_amount    Float
  discount_amount  Float
  final_amount     Float

  // Session details
  duration         String
  scheduled_date   DateTime?
  scheduled_time   String?
  meeting_link     String?   // Google Meet link

  // Payment info
  payment_status   String    @default("pending") // pending, completed, failed, refunded
  payment_id       String?
  payment_method   String?

  // Notes
  notes            String?   @db.Text // Student notes/requirements
  admin_notes      String?   @db.Text // Admin internal notes

  // Status tracking
  case_status      String    @default("open") // open, closed
  status           String    @default("initiated") // initiated, scheduled, in_progress, completed, cancelled

  order_id         String    @unique @default(uuid())
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  user             User      @relation("UserCounsellingPurchases", fields: [user_id], references: [user_id], onDelete: Cascade)
  service_type     CounsellingServiceType @relation(fields: [service_type_id], references: [service_type_id])
  counselor        Counselor? @relation(fields: [counselor_id], references: [counselor_id])

  @@index([user_id])
  @@index([service_type_id])
  @@index([counselor_id])
  @@index([payment_status])
  @@index([status])
  @@index([case_status])
  @@map("counselling_purchases")
}